# Deploy to DigitalOcean Droplet on every push to main.
# Required secrets: DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY, DEPLOY_PATH
# Flow: checkout → rsync (no git on server) → docker compose up -d --build
name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          missing=""
          [ -z "${{ secrets.DEPLOY_HOST }}" ] && missing="$missing DEPLOY_HOST"
          [ -z "${{ secrets.DEPLOY_USER }}" ] && missing="$missing DEPLOY_USER"
          [ -z "${{ secrets.DEPLOY_KEY }}" ] && missing="$missing DEPLOY_KEY"
          [ -z "${{ secrets.DEPLOY_PATH }}" ] && missing="$missing DEPLOY_PATH"
          if [ -n "$missing" ]; then
            echo "::error::Missing GitHub secrets:$missing. Add them in Settings → Secrets and variables → Actions."
            exit 1
          fi
          if echo "$DEPLOY_KEY" | grep -qE '^ssh-(ed25519|rsa|ecdsa) '; then
            echo "::error::DEPLOY_KEY looks like a PUBLIC key. Use the PRIVATE key (id_ed25519 or id_rsa file). Public key goes in authorized_keys on the server."
            exit 1
          fi
          if ! echo "$DEPLOY_KEY" | grep -q '-----BEGIN'; then
            echo "::error::DEPLOY_KEY should be a private key (starts with -----BEGIN OPENSSH PRIVATE KEY----- or -----BEGIN RSA PRIVATE KEY-----)."
            exit 1
          fi

      - name: Setup SSH key
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST_FINGERPRINT: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if ! ssh-keygen -y -f ~/.ssh/deploy_key >/dev/null 2>&1; then
            echo "::error::DEPLOY_KEY is invalid (corrupted, passphrase-protected, or wrong format). Use a non-encrypted private key. Run: ssh-keygen -t ed25519 -f deploy_key -N ''"
            exit 1
          fi
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} > ~/.ssh/known_hosts.scan 2>/dev/null || true
          if [ -n "$DEPLOY_HOST_FINGERPRINT" ]; then
            got=$(ssh-keygen -lf ~/.ssh/known_hosts.scan 2>/dev/null | head -1 | awk '{print $2}')
            want="$DEPLOY_HOST_FINGERPRINT"
            if [ "$got" != "$want" ]; then
              echo "::error::Host key fingerprint mismatch. Got: $got Expected: $want"
              exit 1
            fi
          fi
          cat ~/.ssh/known_hosts.scan >> ~/.ssh/known_hosts

      - name: Sync code to Droplet
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude 'backend/.env' \
            --exclude '.env' \
            --exclude '.env.local' \
            --exclude '.env.production' \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.git' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/ 

      - name: Build and restart on Droplet
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            cd "${{ secrets.DEPLOY_PATH }}"
            if [ ! -f backend/.env ]; then cp backend/.env.example backend/.env 2>/dev/null || true; fi
            docker compose up -d --build
