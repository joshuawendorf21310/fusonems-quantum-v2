"""
Vulnerability Model for FedRAMP RA-5 (Vulnerability Scanning) Compliance

This model tracks:
- CVE records from NIST NVD
- Affected components (Python packages, npm packages, etc.)
- Severity classification (CVSS scores)
- Remediation status
- Risk assessment
- POA&M tracking
"""

from datetime import datetime
from enum import Enum
from typing import Optional

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    Float,
    ForeignKey,
    Index,
    Integer,
    JSON,
    String,
    Text,
    func,
)
from sqlalchemy.orm import relationship

from core.database import Base


class VulnerabilitySeverity(str, Enum):
    """CVSS severity levels"""
    CRITICAL = "critical"  # CVSS 9.0-10.0
    HIGH = "high"  # CVSS 7.0-8.9
    MEDIUM = "medium"  # CVSS 4.0-6.9
    LOW = "low"  # CVSS 0.1-3.9
    NONE = "none"  # CVSS 0.0


class RemediationStatus(str, Enum):
    """Remediation status for vulnerabilities"""
    OPEN = "open"  # Not yet addressed
    IN_PROGRESS = "in_progress"  # Remediation in progress
    PATCHED = "patched"  # Patched/updated
    MITIGATED = "mitigated"  # Mitigated with workaround
    ACCEPTED = "accepted"  # Risk accepted (with justification)
    FALSE_POSITIVE = "false_positive"  # Verified as false positive
    DEFERRED = "deferred"  # Deferred to future release


class ComponentType(str, Enum):
    """Type of component affected by vulnerability"""
    PYTHON_PACKAGE = "python_package"
    NPM_PACKAGE = "npm_package"
    SYSTEM_LIBRARY = "system_library"
    OPERATING_SYSTEM = "operating_system"
    CONTAINER_IMAGE = "container_image"
    INFRASTRUCTURE = "infrastructure"


class Vulnerability(Base):
    """
    Vulnerability record tracking CVE information and remediation status.
    
    FedRAMP RA-5: Vulnerability scanning and tracking.
    """
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # CVE Information
    cve_id = Column(String(32), nullable=False, unique=True, index=True)  # e.g., "CVE-2024-1234"
    cve_description = Column(Text, nullable=True)
    cve_published_date = Column(DateTime(timezone=True), nullable=True)
    cve_last_modified_date = Column(DateTime(timezone=True), nullable=True)
    
    # CVSS Scores
    cvss_v2_score = Column(Float, nullable=True)
    cvss_v2_vector = Column(String(256), nullable=True)
    cvss_v3_score = Column(Float, nullable=True)
    cvss_v3_vector = Column(String(256), nullable=True)
    cvss_v31_score = Column(Float, nullable=True)
    cvss_v31_vector = Column(String(256), nullable=True)
    
    # Severity Classification
    severity = Column(String(16), nullable=False, default=VulnerabilitySeverity.NONE.value, index=True)
    base_score = Column(Float, nullable=True, index=True)  # Highest CVSS score
    
    # Affected Components
    component_type = Column(String(32), nullable=False, index=True)
    component_name = Column(String(256), nullable=False, index=True)
    component_version = Column(String(128), nullable=True)
    affected_versions = Column(JSON, nullable=True)  # List of affected version ranges
    
    # Remediation
    remediation_status = Column(
        String(32),
        nullable=False,
        default=RemediationStatus.OPEN.value,
        index=True
    )
    remediation_notes = Column(Text, nullable=True)
    remediation_date = Column(DateTime(timezone=True), nullable=True)
    remediation_version = Column(String(128), nullable=True)  # Version that fixes the issue
    
    # Risk Assessment
    risk_assessment = Column(Text, nullable=True)
    exploitability = Column(String(32), nullable=True)  # "exploitable", "not_exploitable", "unknown"
    impact_assessment = Column(Text, nullable=True)
    
    # POA&M Tracking
    poam_id = Column(String(128), nullable=True, index=True)
    poam_status = Column(String(32), nullable=True)
    poam_due_date = Column(DateTime(timezone=True), nullable=True)
    
    # Additional Metadata
    references = Column(JSON, nullable=True)  # List of reference URLs
    cwe_ids = Column(JSON, nullable=True)  # List of CWE IDs
    nvd_data = Column(JSON, nullable=True)  # Full NVD API response for reference
    
    # Scan Information
    first_detected_at = Column(DateTime(timezone=True), nullable=False, server_default=func.now())
    last_scanned_at = Column(DateTime(timezone=True), nullable=True)
    scan_id = Column(Integer, ForeignKey("vulnerability_scans.id"), nullable=True, index=True)
    
    # Status
    is_active = Column(Boolean, nullable=False, default=True, index=True)
    is_false_positive = Column(Boolean, nullable=False, default=False)
    false_positive_reason = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), nullable=False, server_default=func.now())
    updated_at = Column(DateTime(timezone=True), nullable=True, onupdate=func.now())
    
    # Relationships
    scan = relationship("VulnerabilityScan", back_populates="vulnerabilities")
    
    __table_args__ = (
        Index("idx_vulnerability_severity_status", "severity", "remediation_status"),
        Index("idx_vulnerability_component", "component_type", "component_name"),
        Index("idx_vulnerability_cve_published", "cve_published_date"),
    )


class VulnerabilityScan(Base):
    """
    Vulnerability scan execution record.
    
    Tracks scheduled and ad-hoc vulnerability scans.
    """
    __tablename__ = "vulnerability_scans"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # Scan Metadata
    scan_type = Column(String(32), nullable=False)  # "scheduled", "ad_hoc", "manual"
    scan_status = Column(String(32), nullable=False, default="running")  # "running", "completed", "failed"
    
    # Scan Configuration
    scan_components = Column(JSON, nullable=True)  # List of component types scanned
    scan_depth = Column(String(32), nullable=True)  # "full", "quick", "incremental"
    
    # Results
    vulnerabilities_found = Column(Integer, nullable=False, default=0)
    vulnerabilities_critical = Column(Integer, nullable=False, default=0)
    vulnerabilities_high = Column(Integer, nullable=False, default=0)
    vulnerabilities_medium = Column(Integer, nullable=False, default=0)
    vulnerabilities_low = Column(Integer, nullable=False, default=0)
    
    # Execution Details
    started_at = Column(DateTime(timezone=True), nullable=False, server_default=func.now())
    completed_at = Column(DateTime(timezone=True), nullable=True)
    duration_seconds = Column(Integer, nullable=True)
    
    # Error Handling
    error_message = Column(Text, nullable=True)
    error_details = Column(JSON, nullable=True)
    
    # Scan Output
    scan_output = Column(JSON, nullable=True)  # Detailed scan results
    scan_summary = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), nullable=False, server_default=func.now())
    
    # Relationships
    vulnerabilities = relationship("Vulnerability", back_populates="scan")
    
    __table_args__ = (
        Index("idx_scan_status_created", "scan_status", "created_at"),
    )


class VulnerabilityRemediation(Base):
    """
    Remediation tracking for vulnerabilities.
    
    Tracks remediation actions, patches, and workarounds.
    """
    __tablename__ = "vulnerability_remediations"
    
    id = Column(Integer, primary_key=True, index=True)
    vulnerability_id = Column(Integer, ForeignKey("vulnerabilities.id"), nullable=False, index=True)
    
    # Remediation Details
    action_type = Column(String(32), nullable=False)  # "patch", "update", "mitigation", "workaround"
    action_description = Column(Text, nullable=False)
    action_taken_by = Column(String(256), nullable=True)  # User/system that took action
    
    # Remediation Status
    status = Column(String(32), nullable=False, default=RemediationStatus.IN_PROGRESS.value)
    effective_date = Column(DateTime(timezone=True), nullable=True)
    verified_date = Column(DateTime(timezone=True), nullable=True)
    verified_by = Column(String(256), nullable=True)
    
    # Related Information
    patch_version = Column(String(128), nullable=True)
    patch_url = Column(String(512), nullable=True)
    workaround_instructions = Column(Text, nullable=True)
    
    # Notes
    notes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), nullable=False, server_default=func.now())
    updated_at = Column(DateTime(timezone=True), nullable=True, onupdate=func.now())
    
    # Relationships
    vulnerability = relationship("Vulnerability")
    
    __table_args__ = (
        Index("idx_remediation_vulnerability_status", "vulnerability_id", "status"),
    )
